apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  namespace: monitoring
data:
  otel-collector-config.yaml: |
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
      # Collects logs from /var/log/pods on the node
      filelog:
        include: [ /var/log/pods/*/*/*.log ]
        exclude: [ /var/log/pods/monitoring_*/*/*.log ] # Don't log the logging stack
        start_at: end
        processors: [k8sattributes]

    processors:
      batch:
        send_batch_size: 1000
        timeout: 10s
      k8sattributes:
        auth_type: "serviceAccount"
        passthrough: false
        extract:
          metadata:
            - k8s.pod.name
            - k8s.namespace.name
            - k8s.node.name
            - k8s.deployment.name

    exporters:
      # Metrics -> Mimir (Prometheus format)
      prometheusremotewrite:
        endpoint: "http://lgtm-stack-mimir-distributor.monitoring.svc:8080/api/v1/push"
      
      # Logs -> Loki (OTLP format)
      otlphttp/loki:
        endpoint: "http://lgtm-stack-loki-gateway.monitoring.svc/otlp"
        tls:
          insecure: true

      # Traces -> Tempo (OTLP format)
      otlp/tempo:
        endpoint: "lgtm-stack-tempo-distributor.monitoring.svc:4317"
        tls:
          insecure: true

    service:
      pipelines:
        metrics:
          receivers: [otlp]
          processors: [batch]
          exporters: [prometheusremotewrite]
        logs:
          receivers: [otlp, filelog]
          processors: [k8sattributes, batch]
          exporters: [otlphttp/loki]
        traces:
          receivers: [otlp]
          processors: [k8sattributes, batch]
          exporters: [otlp/tempo]